# CircleCI Configuration
# Mirror of GitHub Actions workflows using the same ci_orchestrator.py logic.
# ⌬ Auto-generated by hydrate.py — DO NOT EDIT DIRECTLY

version: 2.1

orbs:
  node: circleci/node@7.2.1
  win: circleci/windows@5.1.1

executors:
  linux-executor:
    docker:
      - image: cimg/python:3.13.11
    environment:
      UV_LINK_MODE: "copy"
      TAURI_TARGET_TRIPLE: "x86_64-unknown-linux-gnu"

jobs:
  validate:
    executor: linux-executor
    steps:
      - checkout
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> $BASH_ENV
      - run:
          name: Sync Dependencies
          command: uv sync --all-extras
      - run:
          name: Validate Hydration
          command: uv run python scripts/ci_orchestrator.py validate
      - store_test_results:
          path: tests/

  lint:
    executor: linux-executor
    steps:
      - checkout
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> $BASH_ENV
      - node/install:
          node-version: "24.12.0"
      - run:
          name: Sync Dependencies
          command: uv sync --all-extras
      - run:
          name: Run Linters
          command: uv run python scripts/ci_orchestrator.py lint
      - store_test_results:
          path: tests/

  test:
    executor: linux-executor
    steps:
      - checkout
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> $BASH_ENV
      - run:
          name: Sync Dependencies
          command: uv sync --all-extras
      - run:
          name: Run Tests
          command: uv run python scripts/ci_orchestrator.py test
      - store_test_results:
          path: tests/
      - store_artifacts:
          path: tests/test_errors.txt
          destination: test-reports

  build-linux-deb:
    # Parallel Job Part 1: Debian/Ubuntu Bundling
    # Split to bypass CircleCI's 60-minute absolute job timeout for large 1.6GiB payloads.
    executor: linux-executor
    steps:
      - checkout
      - run:
          name: Install System Dependencies
          command: |
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo rm -f /etc/apt/sources.list.d/docker.list /etc/apt/sources.list.d/archive_uri-https_download_docker_com_linux_ubuntu-jammy.list /etc/apt/sources.list.d/docker.list.distUpgrade
            sudo apt-get update -qq
            sudo apt-get install -y -qq libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev libgtk-3-dev rpm
      - run:
          name: Install uv
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> $BASH_ENV
      - run:
          name: Setup Rust
          command: |
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            echo 'source $HOME/.cargo/env' >> $BASH_ENV
            source $HOME/.cargo/env
            rustup target add x86_64-unknown-linux-gnu
      - run:
          name: Sync Dependencies
          command: uv sync --all-extras
      - node/install:
          node-version: "24.12.0"
      - run:
          name: Environment Setup & Hydration
          command: |
            mkdir -p ui/src-tauri/binaries
            mkdir -p ui/src-tauri/resources
            uv run python scripts/ci_orchestrator.py validate
      - run:
          name: Build Backend & Sidecars
          command: PYTHONWARNINGS="ignore" uv run python scripts/ci_orchestrator.py build-backend --target x86_64-unknown-linux-gnu
          no_output_timeout: 45m
      - run:
          name: Verify Backend Sidecar
          command: uv run python scripts/ci_orchestrator.py verify-sidecar --target x86_64-unknown-linux-gnu
      - run:
          name: Build Desktop App (DEB)
          command: PYTHONWARNINGS="ignore" uv run python scripts/ci_orchestrator.py build-desktop --target x86_64-unknown-linux-gnu --bundles deb
          no_output_timeout: 100m
          environment:
            GITHUB_TOKEN: ${CUSTOM_DEPLOY_TOKEN}
      # - run:
      #     name: Generate Linux Packages
      #     command: uv run python scripts/ci_orchestrator.py linux-packages --verbose
      - persist_to_workspace:
          root: .
          paths:
            - ui/src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/
            - ui/src-tauri/binaries/
            - ui/src-tauri/resources/
            - ui/src-tauri/tauri.conf.json
            - ui/src-tauri/Cargo.toml
            - ui/src-tauri/Cargo.lock
            - ui/src-tauri/src/
            - ui/src-tauri/capabilities/
            - ui/src-tauri/icons/
            - ui/package.json
            - ui/package-lock.json
            - ui/dist/
            - governance/
            - resources/
            - pyproject.toml
            - packaging/
      - store_artifacts:
          path: ui/src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/deb
          destination: bundles-deb


  build-windows-backend:
    executor:
      name: win/default
      size: "large"
    environment:
      UV_LINK_MODE: "copy"
      TAURI_TARGET_TRIPLE: "x86_64-pc-windows-msvc"
    steps:
      - checkout
      - run:
          name: Install uv
          shell: powershell.exe
          command: irm https://astral.sh/uv/install.ps1 | iex
      - run:
          name: Install Node.js
          shell: powershell.exe
          command: |
             $NodeVersion = "24.12.0"
             Write-Host "Downloading Node.js v$NodeVersion..."
             Invoke-WebRequest "https://nodejs.org/dist/v$NodeVersion/node-v$NodeVersion-win-x64.zip" -OutFile "node.zip"
             Expand-Archive node.zip -DestinationPath "$HOME\node_app" -Force
             $NodePath = "$HOME\node_app\node-v$NodeVersion-win-x64"
             [Environment]::SetEnvironmentVariable("PATH", "$NodePath;" + [Environment]::GetEnvironmentVariable("PATH", "User"), "User")
             $env:PATH = "$NodePath;" + $env:PATH
             node --version
             npm --version
      - run:
          name: Install Python via uv
          shell: powershell.exe
          command: |
             $uv = "$HOME\.local\bin\uv.exe"
             & $uv python install 3.13.11
             & $uv venv
             [Environment]::SetEnvironmentVariable("PATH", "$env:PATH;$HOME\.local\bin", "User")
      - run:
          name: Setup Rust
          shell: powershell.exe
          command: |
             function Get-RustupPath {
                 $paths = @(
                     (Join-Path $env:USERPROFILE ".cargo\bin\rustup.exe"),
                     (Join-Path $HOME ".cargo\bin\rustup.exe"),
                     "C:\Users\circleci\.cargo\bin\rustup.exe"
                 )
                 foreach ($p in $paths) { if (Test-Path $p) { return $p } }
                 return $null
             }
             $rustup = Get-RustupPath
             if ($null -eq $rustup) {
                 Invoke-WebRequest -Uri "https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe" -OutFile "rustup-init.exe"
                 Start-Process -FilePath ".\rustup-init.exe" -ArgumentList "-y", "--default-host", "x86_64-pc-windows-msvc", "--default-toolchain", "stable", "--no-modify-path" -Wait
                 Remove-Item "rustup-init.exe"
                 $rustup = Get-RustupPath
             }
             if ($null -ne $rustup) {
                 & $rustup target add x86_64-pc-windows-msvc
                 $binDir = Split-Path $rustup
                 $env:PATH = "$binDir;" + $env:PATH
                 [Environment]::SetEnvironmentVariable("PATH", "$binDir;" + [Environment]::GetEnvironmentVariable("PATH", "User"), "User")
             }
      - run:
          name: Sync Dependencies
          shell: powershell.exe
          command: |
             $env:PATH += ";$env:USERPROFILE\.cargo\bin"
             $env:PYTHONWARNINGS = "ignore"
             $uv = "$HOME\.local\bin\uv.exe"
             & $uv sync --all-extras
      - run:
          name: Environment Setup & Hydration
          shell: powershell.exe
          command: |
            $env:PATH += ";$env:USERPROFILE\.cargo\bin;$HOME\.local\bin"
            New-Item -ItemType Directory -Force -Path "ui\src-tauri\binaries"
            New-Item -ItemType Directory -Force -Path "ui\src-tauri\resources"
            $uv = "$HOME\.local\bin\uv.exe"
            & $uv run python scripts/ci_orchestrator.py validate
      - run:
          name: Build Backend & Sidecars
          shell: powershell.exe
          command: |
            $env:PATH += ";$env:USERPROFILE\.cargo\bin;$HOME\.local\bin"
            $uv = "$HOME\.local\bin\uv.exe"
            $env:PYTHONWARNINGS = "ignore"
            & $uv run python scripts/ci_orchestrator.py build-backend --target x86_64-pc-windows-msvc
          no_output_timeout: 90m
      - run:
          name: Verify Backend Sidecar
          shell: powershell.exe
          command: |
             $env:PATH += ";$env:USERPROFILE\.cargo\bin;$HOME\.local\bin"
             $uv = "$HOME\.local\bin\uv.exe"
             & $uv run python scripts/ci_orchestrator.py verify-sidecar --target x86_64-pc-windows-msvc
      - persist_to_workspace:
          root: .
          paths:
            - ui/src-tauri/binaries/
            - ui/src-tauri/resources/
            - governance/

  build-windows-desktop:
    executor:
      name: win/default
      size: "large"
    environment:
      UV_LINK_MODE: "copy"
      TAURI_TARGET_TRIPLE: "x86_64-pc-windows-msvc"
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install uv
          shell: powershell.exe
          command: irm https://astral.sh/uv/install.ps1 | iex
      - run:
          name: Install Node.js
          shell: powershell.exe
          command: |
             $NodeVersion = "24.12.0"
             Write-Host "Downloading Node.js v$NodeVersion..."
             Invoke-WebRequest "https://nodejs.org/dist/v$NodeVersion/node-v$NodeVersion-win-x64.zip" -OutFile "node.zip"
             Expand-Archive node.zip -DestinationPath "$HOME\node_app" -Force
             $NodePath = "$HOME\node_app\node-v$NodeVersion-win-x64"
             [Environment]::SetEnvironmentVariable("PATH", "$NodePath;" + [Environment]::GetEnvironmentVariable("PATH", "User"), "User")
             $env:PATH = "$NodePath;" + $env:PATH
             node --version
             npm --version
      - run:
          name: Install Python via uv
          shell: powershell.exe
          command: |
             $uv = "$HOME\.local\bin\uv.exe"
             & $uv python install 3.13.11
             & $uv venv
             [Environment]::SetEnvironmentVariable("PATH", "$env:PATH;$HOME\.local\bin", "User")
      - run:
          name: Setup Rust
          shell: powershell.exe
          command: |
             function Get-RustupPath {
                 $paths = @(
                     (Join-Path $env:USERPROFILE ".cargo\bin\rustup.exe"),
                     (Join-Path $HOME ".cargo\bin\rustup.exe"),
                     "C:\Users\circleci\.cargo\bin\rustup.exe"
                 )
                 foreach ($p in $paths) { if (Test-Path $p) { return $p } }
                 return $null
             }
             $rustup = Get-RustupPath
             if ($null -eq $rustup) {
                 Invoke-WebRequest -Uri "https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe" -OutFile "rustup-init.exe"
                 Start-Process -FilePath ".\rustup-init.exe" -ArgumentList "-y", "--default-host", "x86_64-pc-windows-msvc", "--default-toolchain", "stable", "--no-modify-path" -Wait
                 Remove-Item "rustup-init.exe"
                 $rustup = Get-RustupPath
             }
             if ($null -ne $rustup) {
                 & $rustup target add x86_64-pc-windows-msvc
                 $binDir = Split-Path $rustup
                 $env:PATH = "$binDir;" + $env:PATH
                 [Environment]::SetEnvironmentVariable("PATH", "$binDir;" + [Environment]::GetEnvironmentVariable("PATH", "User"), "User")
             }
      - run:
          name: Sync Dependencies
          shell: powershell.exe
          command: |
             $env:PATH += ";$env:USERPROFILE\.cargo\bin"
             $env:PYTHONWARNINGS = "ignore"
             $uv = "$HOME\.local\bin\uv.exe"
             & $uv sync --all-extras
      - run:
          name: Environment Setup & Hydration
          shell: powershell.exe
          command: |
            $env:PATH += ";$env:USERPROFILE\.cargo\bin;$HOME\.local\bin"
            $uv = "$HOME\.local\bin\uv.exe"
            & $uv run python scripts/ci_orchestrator.py validate
      - run:
          name: Verify Backend Sidecar
          shell: powershell.exe
          command: |
             $env:PATH += ";$env:USERPROFILE\.cargo\bin;$HOME\.local\bin"
             $uv = "$HOME\.local\bin\uv.exe"
             & $uv run python scripts/ci_orchestrator.py verify-sidecar --target x86_64-pc-windows-msvc
      - run:
          name: Build Desktop App (NSIS)
          shell: powershell.exe
          command: |
             $env:PATH += ";$env:USERPROFILE\.cargo\bin;$HOME\.local\bin"
             $uv = "$HOME\.local\bin\uv.exe"
             $env:PYTHONWARNINGS = "ignore"
             & $uv run python scripts/ci_orchestrator.py build-desktop --target x86_64-pc-windows-msvc --bundles nsis
          no_output_timeout: 120m
          environment:
            GITHUB_TOKEN: ${CUSTOM_DEPLOY_TOKEN}
      - persist_to_workspace:
          root: .
          paths:
            - ui/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/
            - ui/src-tauri/binaries/
            - ui/src-tauri/resources/
            - ui/src-tauri/tauri.conf.json
            - ui/src-tauri/Cargo.toml
            - ui/src-tauri/Cargo.lock
            - ui/src-tauri/src/
            - ui/src-tauri/capabilities/
            - ui/src-tauri/icons/
            - ui/package.json
            - ui/package-lock.json
            - ui/dist/
            - governance/
            - resources/
            - pyproject.toml
            - packaging/
      - store_artifacts:
          path: ui/src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis
          destination: bundles-nsis

workflows:
  build-and-test:
    jobs:
      - validate
      - lint:
          requires:
            - validate
      - test:
          requires:
            - validate
      - build-linux-deb:
          requires:
            - test
          filters:
            tags:
              only: /^v.*/
            branches:
              only:
                - main
      - build-windows-backend:
          requires:
            - test
          filters:
            tags:
              only: /^v.*/
            branches:
              only:
                - main
      - build-windows-desktop:
          requires:
            - build-windows-backend
          filters:
            tags:
              only: /^v.*/
            branches:
              only:
                - main
