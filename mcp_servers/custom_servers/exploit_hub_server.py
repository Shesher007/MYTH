import json
import os
import re
import sys
from pathlib import Path
from typing import Dict, List

from fastmcp import FastMCP

# Add parent to path for mcp_common
sys.path.append(str(Path(__file__).parent.parent))
from mcp_common import (
    CircuitBreaker,
    DependencyGuard,
    MCPUtils,
    ironclad_guard,
    tool_exception_handler,
)

# --- Server ---
mcp = FastMCP("Exploit Hub")
edb_cb = CircuitBreaker()


@mcp.tool()
@tool_exception_handler
@ironclad_guard
@DependencyGuard.require(["searchsploit"])
@edb_cb
async def search_local_exploits(query: str) -> List[Dict]:
    """Search local Exploit-DB via Searchsploit."""
    cmd = ["searchsploit", query, "--json"]
    res = await MCPUtils.run_command_async(cmd)

    if not res["success"]:
        return []
    try:
        data = json.loads(res["stdout"])
        return data.get("RESULTS_EXPLOIT", [])
    except Exception:
        return []


@mcp.tool()
@tool_exception_handler
@ironclad_guard
@DependencyGuard.require(["searchsploit"])
async def download_exploit_poc(edb_id: str) -> str:
    """Extract and download Proof-of-Concept code for a specific EDB-ID."""
    cmd = ["searchsploit", "-m", edb_id]
    res = await MCPUtils.run_command_async(cmd)

    if res["success"]:
        # Find where it was downloaded (usually current dir)
        # Searchsploit usually prints "Copied to: /path/to/file"
        match = re.search(r"Copied to: (.*)", res["stdout"])
        if match:
            path = Path(match.group(1).strip())
            if path.exists():
                content = path.read_text(errors="ignore")
                path.unlink()  # Cleanup
                return content
    return "Error: POC not found or failed to download."


if __name__ == "__main__":
    port = int(os.getenv("FASTMCP_PORT", 8205))
    mcp.run(transport="sse", port=port, show_banner=False)
