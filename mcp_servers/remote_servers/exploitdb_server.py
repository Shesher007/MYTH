#!/usr/bin/env python3
import os
import aiohttp
import asyncio
import sys
from pathlib import Path
from typing import Dict, List, Any, Optional
from pydantic import BaseModel, Field
from fastmcp import FastMCP

# Add parent to path for mcp_common
sys.path.append(str(Path(__file__).parent.parent))
import json
from mcp_common import MCPUtils, QuantumEnricher, CircuitBreaker, tool_exception_handler, logger

# --- Server ---
mcp = FastMCP("Exploit-DB Server")
edb_cb = CircuitBreaker()

@mcp.tool()
@tool_exception_handler
@edb_cb
@MCPUtils.cache_result(ttl_seconds=86400)
async def exploitdb_search(query: str) -> List[Dict]:
    """Search exploits with performance telemetry."""
    start = asyncio.get_event_loop().time()
    url = "https://gitlab.com/api/v4/projects/exploit-database%2Fexploit-database/repository/tree"
    params = {"path": "exploits", "recursive": "true", "per_page": 100}
    
    async with aiohttp.ClientSession() as session:
        async with session.get(url, params=params) as resp:
            if resp.status != 200: return [{"error": "Exploit-DB mirror unreachable"}]
            data = await resp.json()
            matches = [item for item in data if query.lower() in item['name'].lower()][:10]
            if matches: matches.append({"telemetry": QuantumEnricher.get_telemetry(start)})
            return matches

if __name__ == "__main__":
    port = int(os.getenv("FASTMCP_PORT", 8108))
    mcp.run(transport="sse", port=port, show_banner=False)
