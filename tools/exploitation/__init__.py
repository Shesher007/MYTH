import os
import platform
import shutil

from langchain_core.tools import tool

from tools.utilities.report import format_industrial_result

from .api_prober import (
    api_specification_analyzer as api_specification_analyzer,
)
from .c2_infrastructure import (
    c2_infrastructure_generator as c2_infrastructure_generator,
)
from .c2_infrastructure import (
    icmp_exfiltration_stager as icmp_exfiltration_stager,
)
from .clr_engineering import (
    appdomain_manager_persistence as appdomain_manager_persistence,
)
from .clr_engineering import clr_hosting_generator as clr_hosting_generator
from .clr_engineering import silver_ticket_generator as silver_ticket_generator
from .evasion_generators import amsi_bypass_generator as amsi_bypass_generator
from .evasion_generators import etw_bypass_generator as etw_bypass_generator
from .graphql_prober import graphql_depth_tester as graphql_depth_tester
from .graphql_prober import graphql_introspector as graphql_introspector
from .host_exploitation import (
    antivirus_evasion_checker as antivirus_evasion_checker,
)
from .host_exploitation import apk_analyzer as apk_analyzer
from .host_exploitation import arpspoof_detector as arpspoof_detector
from .host_exploitation import av_sandbox_detector as av_sandbox_detector
from .host_exploitation import (
    bad_usb_payload_generator as bad_usb_payload_generator,
)
from .host_exploitation import (
    bluetooth_device_discovery as bluetooth_device_discovery,
)
from .host_exploitation import dhcp_starvation_test as dhcp_starvation_test
from .host_exploitation import edr_bypass_checker as edr_bypass_checker
from .host_exploitation import firmware_analyzer as firmware_analyzer
from .host_exploitation import iot_device_fingerprint as iot_device_fingerprint
from .host_exploitation import ipa_analyzer as ipa_analyzer
from .host_exploitation import lock_picking_detector as lock_picking_detector
from .host_exploitation import log_clearing_detector as log_clearing_detector
from .host_exploitation import mitm_engine as mitm_engine
from .host_exploitation import (
    mobile_app_traffic_capture as mobile_app_traffic_capture,
)
from .host_exploitation import (
    persistence_mechanism_detector as persistence_mechanism_detector,
)
from .host_exploitation import (
    phishing_campaign_manager as phishing_campaign_manager,
)
from .host_exploitation import rfid_cloner_util as rfid_cloner_util
from .host_exploitation import rfid_nfc_scanner as rfid_nfc_scanner
from .host_exploitation import (
    social_engineering_toolkit as social_engineering_toolkit,
)
from .host_exploitation import stp_attack_detector as stp_attack_detector
from .host_exploitation import wifi_cap_file_analyzer as wifi_cap_file_analyzer
from .host_exploitation import wifi_network_scanner as wifi_network_scanner
from .host_exploitation import (
    wmi_event_subscription_persistence as wmi_event_subscription_persistence,
)
from .identity_exploitation import cloud_metadata_pivot as cloud_metadata_pivot
from .identity_exploitation import (
    container_escape_detector as container_escape_detector,
)
from .identity_exploitation import (
    golden_ticket_command as golden_ticket_command,
)
from .identity_exploitation import (
    gpp_password_decryptor as gpp_password_decryptor,
)
from .identity_exploitation import hash_identifier as hash_identifier
from .identity_exploitation import kerberoasting_mapper as kerberoasting_mapper
from .identity_exploitation import (
    kerberos_delegation_auditor as kerberos_delegation_auditor,
)
from .identity_exploitation import (
    ldap_domain_discovery as ldap_domain_discovery,
)
from .identity_exploitation import (
    linux_priv_escalation_checker as linux_priv_escalation_checker,
)
from .identity_exploitation import ntlm_relay_auditor as ntlm_relay_auditor
from .identity_exploitation import (
    password_spraying_engine as password_spraying_engine,
)
from .identity_exploitation import (
    skeleton_key_code_generator as skeleton_key_code_generator,
)
from .identity_exploitation import (
    skeleton_key_injector_stub as skeleton_key_injector_stub,
)
from .identity_exploitation import smb_share_enumerator as smb_share_enumerator
from .identity_exploitation import (
    windows_priv_escalation_checker as windows_priv_escalation_checker,
)
from .infrastructure_exploitation import dns_tunnel_stager as dns_tunnel_stager
from .infrastructure_exploitation import (
    dns_txt_stager_factory as dns_txt_stager_factory,
)
from .infrastructure_exploitation import (
    egress_filter_mapper as egress_filter_mapper,
)
from .infrastructure_exploitation import (
    modbus_protocol_scanner as modbus_protocol_scanner,
)
from .infrastructure_exploitation import (
    poisoning_surface_mapper as poisoning_surface_mapper,
)
from .infrastructure_exploitation import (
    protocol_relay_auditor as protocol_relay_auditor,
)
from .infrastructure_exploitation import (
    snmp_community_bruteforcer as snmp_community_bruteforcer,
)
from .infrastructure_exploitation import (
    socks5_pivot_generator as socks5_pivot_generator,
)
from .payload_generation import alpha_numeric_encoder as alpha_numeric_encoder
from .payload_generation import polymorphic_mutator as polymorphic_mutator
from .polyglot_payloads import (
    advanced_vba_macro_stager as advanced_vba_macro_stager,
)
from .polyglot_payloads import lnk_payload_generator as lnk_payload_generator
from .polyglot_payloads import (
    multi_os_wrapper_factory as multi_os_wrapper_factory,
)
from .polyglot_payloads import xll_payload_generator as xll_payload_generator
from .process_injection import (
    dll_sideloading_generator as dll_sideloading_generator,
)
from .process_injection import (
    early_bird_injection_generator as early_bird_injection_generator,
)
from .process_injection import fiber_injection_util as fiber_injection_util
from .process_injection import (
    process_ghosting_generator as process_ghosting_generator,
)
from .process_injection import (
    process_hollowing_engine as process_hollowing_engine,
)
from .process_injection import (
    reflective_dll_generator as reflective_dll_generator,
)
from .process_injection import reflective_pe_loader as reflective_pe_loader
from .situational_awareness import ad_schema_mapper as ad_schema_mapper
from .situational_awareness import (
    browser_credential_harvester as browser_credential_harvester,
)
from .situational_awareness import local_network_mapper as local_network_mapper
from .situational_awareness import secret_hunter as secret_hunter
from .situational_awareness import session_enumerator as session_enumerator
from .syscall_factory import dynamic_gate_finder as dynamic_gate_finder
from .syscall_factory import (
    dynamic_unhooking_engine as dynamic_unhooking_engine,
)
from .syscall_factory import (
    indirect_syscall_generator as indirect_syscall_generator,
)


@tool
async def exploitation_arsenal_health_check() -> str:
    """
    Performs a diagnostic of the Exploitation Arsenal, verifying OS-native tool dependencies.
    Checks for: adb, gdb, nmcli/netsh, and powershell.
    """
    try:
        critical_bins = [
            "adb",
            "gdb",
            "powershell" if platform.system() == "Windows" else "pwsh",
        ]
        if platform.system() == "Linux":
            critical_bins.extend(["nmcli", "iwlist"])

        bin_status = {}
        for b in critical_bins:
            path = shutil.which(b)
            bin_status[b] = "AVAILABLE" if path else "MISSING"

        health_report = {
            "os": platform.system(),
            "dependencies": bin_status,
            "architecture": platform.machine(),
            "is_admin": "YES"
            if (os.name == "nt" and os.access("C:\\Windows\\System32", os.W_OK))
            or (os.name != "nt" and os.getuid() == 0)
            else "NO",
        }

        return format_industrial_result(
            "exploitation_arsenal_health_check",
            "Audit Complete",
            confidence=1.0,
            impact="LOW",
            raw_data=health_report,
            summary="Exploitation arsenal health scan finished. Verify missing binaries for specific platform exploitation.",
        )
    except Exception as e:
        return format_industrial_result(
            "exploitation_arsenal_health_check", "Error", error=str(e)
        )
