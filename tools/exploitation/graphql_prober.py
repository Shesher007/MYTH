import json
from typing import Any
import httpx
import asyncio
from datetime import datetime
from myth_config import load_dotenv
from langchain_core.tools import tool
from tools.utilities.report import format_industrial_result

load_dotenv()

# ==============================================================================
# ðŸ§¬ GraphQL Exploitation Frontier Tools
# ==============================================================================

@tool
async def graphql_introspector(url: str, headers: Any = "{}") -> str:
    """
    Executes deep introspection against a GraphQL endpoint to map the schema and identify high-value targets.
    """
    try:
        h_dict = json.loads(headers)
        # Full introspection query
        query = {"query": "{__schema{types{name,kind,description,fields{name,args{name,type{name,kind}},type{name,kind}}}}}"}
        
        async with httpx.AsyncClient(timeout=15, verify=False) as client:
            resp = await client.post(url, json=query, headers=h_dict)
            if resp.status_code != 200:
                return format_industrial_result("graphql_introspector", "Access Denied", error=f"Status {resp.status_code}")

            data = resp.json().get('data', {})
            types = data.get('__schema', {}).get('types', [])
            
            # Identify "Dangerous" types (Auth, Secret)
            high_value = [t['name'] for t in types if any(x in t['name'].lower() for x in ["auth", "secret", "admin", "config"])]

            return format_industrial_result(
                "graphql_introspector",
                "Schema Mapped",
                confidence=1.0,
                raw_data={"type_count": len(types), "high_value_types": high_value},
                summary=f"GraphQL introspection successful. Mapped {len(types)} types. Identified {len(high_value)} sensitive data objects."
            )
    except Exception as e:
        return format_industrial_result("graphql_introspector", "Error", error=str(e))

@tool
async def graphql_depth_tester(url: str) -> str:
    """
    Tests GraphQL resilience against deep circular queries (Complexity-based DoS).
    """
    try:
        # Build 10-level nested query
        nested = "{author{posts{author{posts{author{posts{author{posts{author{name}}}}}}}}}}"
        query = {"query": nested}
        
        async with httpx.AsyncClient(timeout=10, verify=False) as client:
            resp = await client.post(url, json=query)
            vulnerable = resp.status_code == 200 and "data" in resp.text
            
            return format_industrial_result(
                "graphql_depth_tester",
                "Vulnerable" if vulnerable else "Secure",
                confidence=0.9,
                impact="MEDIUM" if vulnerable else "LOW",
                raw_data={"status_code": resp.status_code, "recursion_allowed": vulnerable},
                summary=f"GraphQL depth audit finished. Target {'permitted' if vulnerable else 'blocked'} deep recursion probes."
            )
    except Exception as e:
        return format_industrial_result("graphql_depth_tester", "Error", error=str(e))
